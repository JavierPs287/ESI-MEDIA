<div class="register-container">
  <form *ngIf="editedUser" [formGroup]="editForm" (ngSubmit)="save()" class="edit-mode">

    <!-- Plantilla reutilizable para mensajes de error -->
    <ng-template #errors let-controlName="controlName" let-errors="errors">
      <div class="error-container"
           *ngIf="getControl(controlName)?.invalid && (getControl(controlName)?.touched || getControl(controlName)?.dirty)">
        <p class="error-message" *ngIf="getControl(controlName)?.hasError('required') && errors?.required">
          {{ errors.required }}
        </p>
        <p class="error-message" *ngIf="getControl(controlName)?.hasError('maxlength') && errors?.maxlength">
          {{ errors.maxlength }}
        </p>
        <p class="error-message" *ngIf="getControl(controlName)?.hasError('minlength') && errors?.minlength">
          {{ errors.minlength }}
        </p>
        <p class="error-message" *ngIf="getControl(controlName)?.hasError('minAge') && errors?.minAge">
          {{ errors.minAge }}
        </p>
      </div>
    </ng-template>

    <!-- Nombre y apellidos: vista / edición -->
    <ng-container *ngIf="!editMode; else editNameBlock">
      <div class="form-field">
        <label for="name">Nombre </label>
        <p class="info-name"> {{ name }}</p>
      </div>
      <div class="form-field">
        <label for="lastName">Apellidos </label>
        <p class="info-lastName"> {{ lastName }}</p>
      </div>
    </ng-container>

    <ng-template #editNameBlock>
      <div class="form-field">
        <label for="name">Nombre</label>
        <input id="name" type="text" placeholder="{{ name }}" formControlName="name">
        <ng-container *ngTemplateOutlet="errors; context:{controlName: 'name', errors: { required: ' El campo es obligatorio. ', maxlength: ' Máximo 50 caracteres. '}}"></ng-container>
      </div>

      <div class="form-field">
        <label for="lastName">Apellidos</label>
        <input id="lastName" type="text" placeholder="{{ lastName }}" formControlName="lastName">
        <ng-container *ngTemplateOutlet="errors; context:{controlName: 'lastName', errors: { required: ' El campo es obligatorio. ', maxlength: ' Máximo 100 caracteres. '}}"></ng-container>
      </div>
    </ng-template>

    <!-- Email (solo visual) -->
    <div class="form-field">
      <label for="email">Correo electrónico</label>
      <p class="email">{{ email }}</p>
    </div>

    <!-- Bloque para USUARIO -->
    <ng-container *ngIf="role === 'USUARIO'">
      <ng-container *ngIf="!editMode; else editUsuarioBlock">
        <div class="form-field">
          <label for="alias">Alias </label>
          <p class="info-alias"> {{ alias }}</p>
        </div>
        <div class="form-field">
          <label for="birthDate">Fecha de nacimiento</label>
          <p class="info-birthDate"> {{ birthDate }}</p>
        </div>
        <div class="form-field">
          <label for="vip">VIP</label>
          <p class="info-vip"> {{ vip }}</p>
        </div>
      </ng-container>

      <ng-template #editUsuarioBlock>
        <div class="form-field">
          <label for="alias">Alias</label>
          <input id="alias" type="text" placeholder="{{ alias }}" formControlName="alias">
          <ng-container *ngTemplateOutlet="errors; context:{controlName: 'alias', errors: { maxlength: ' Máximo 20 caracteres. ', minlength: ' Mínimo 3 caracteres. '}}"></ng-container>
        </div>

        <div class="form-field">
          <label for="birthDate">Fecha de nacimiento</label>
          <input id="birthDate" type="date" formControlName="birthDate">
          <ng-container *ngTemplateOutlet="errors; context:{controlName: 'birthDate', errors: { required: ' El campo es obligatorio. ', minAge: ' Debes tener al menos 4 años para registrarte. '}}"></ng-container>
        </div>

        <div class="form-field">
          <label for="vip">VIP</label>
          <div class="btn-container">
            <button
              type="button" class="btn-vip" (click)="toggleVip()"
              [ngClass]="{'vip-active': isVip, 'vip-inactive': !isVip}">
              {{ isVip ? 'VIP' : 'No eres VIP' }}
            </button>
          </div>
        </div>
      </ng-template>
    </ng-container>

    <!-- Bloque para CREADOR -->
    <ng-container *ngIf="role === 'CREADOR'">
      <div class="form-field" *ngIf="!editMode; else editCreadorBlock">
        <label for="description">Descripción </label>
        <p class="info-description"> {{ description }}</p>
      </div>

      <ng-template #editCreadorBlock>
        <div class="form-field">
          <label for="description">Descripción</label>
          <textarea class="area-descripcion" placeholder="description" formControlName="description"></textarea>
          <ng-container *ngTemplateOutlet="errors; context:{controlName: 'description', errors: { maxlength: ' Máximo 500 caracteres. '}}"></ng-container>
        </div>
      </ng-template>

      <div class="form-field">
        <label for="type">Tipo de creador </label>
        <p class="info-type"> {{ type }}</p>
      </div>

      <ng-container *ngIf="!editMode; else editFieldBlock">
        <div class="form-field">
          <label for="field">Especialidad </label>
          <p class="info-field"> {{ field }}</p>
        </div>
      </ng-container>

      <ng-template #editFieldBlock>
        <div class="form-field">
          <label for="field">Especialidad </label>
          <select class="form-select" id="field" formControlName="field">
            <option value="">Seleccionar especialidad</option>
            <option *ngFor="let esp of fields" [value]="esp">{{ esp }}</option>
          </select>
          <ng-container *ngTemplateOutlet="errors; context:{controlName: 'field', errors: { required: ' El campo es obligatorio. '}}"></ng-container>
        </div>
      </ng-template>
    </ng-container>

    <!-- Bloque para ADMIN -->
    <ng-container *ngIf="role === 'ADMIN'">
      <div class="form-field" *ngIf="!editMode; else editAdminBlock">
        <label for="department">Departamento </label>
        <p class="info-department"> {{ department }}</p>
      </div>

      <ng-template #editAdminBlock>
        <div class="form-field">
          <label for="departamento">Departamento</label>
          <select class="form-select" id="departamento" formControlName="department">
            <option value="">Seleccionar departamento</option>
            <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
          </select>
          <ng-container *ngTemplateOutlet="errors; context:{controlName: 'department', errors: { required: 'El departamento es obligatorio.'}}"></ng-container>
        </div>
      </ng-template>
    </ng-container>

    <!-- Foto actual / selección -->
    <ng-container *ngIf="!editMode; else editPhotoBlock">
      <div class="form-field">
        <label for="foto">Foto de perfil actual</label>
        <div class="photo-current">
          <img [src]="getAvatar()" alt="Foto de perfil actual" class="current-photo">
        </div>
      </div>
    </ng-container>

    <ng-template #editPhotoBlock>
      <div class="form-field">
        <label for="foto">Foto de perfil </label>
        <button type="button"
                [disabled]="!editMode"
                class="photo-selector-btn"
                (click)="togglePhotoOptions()">
          {{ selectedPhoto ? 'Cambiar foto' : 'Seleccionar foto' }}
        </button>
        <div class="photo-options" *ngIf="showPhotoOptions">
          <div class="photo-grid">
            <img *ngFor="let avatar of photoOptions.slice(1)"
                 [src]="avatar.url"
                 [alt]="avatar.id"
                 class="photo-option"
                 [class.selected]="selectedPhoto === avatar.id"
                 (click)="selectPhoto(avatar.id)"
                 (keydown.enter)="selectPhoto(avatar.id)">
          </div>
          <a class="link" href="http://www.freepik.com">Designed by studiogstock / Freepik</a>
        </div>
      </div>
    </ng-template>

    <!-- Cambiar contraseña -->
    <div class="form-field" *ngIf="isMe">
      <label for="Contraseña">Contraseña</label>
      <button type="button" routerLink="/forgotpassword" class="btn-change-password">Cambiar contraseña</button>
    </div>

    <!-- Acciones -->
    <div class="actions">
      <button class="btn" type="button" (click)="startEdit()" *ngIf="!editMode">Modificar datos</button>
      <button type="button" class="btn" (click)="save()" *ngIf="editMode" [disabled]="isSubmitting">Guardar</button>
      <button class="btn" type="button" (click)="cancelEdit()" *ngIf="editMode">Cancelar</button>
    </div>
  </form>
</div>
